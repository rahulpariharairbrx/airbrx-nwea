# ============================================================================
# K6 Load Testing Dockerfile
# ============================================================================
# Multi-stage build for k6 load testing with custom extensions
# Usage: docker build -t airbrx-k6-testing .
#        docker run -v $(pwd):/tests airbrx-k6-testing run /tests/airbrx_k6_loadtesting.js
# ============================================================================

# Stage 1: Build custom k6 with extensions (if needed)
FROM golang:1.21-alpine AS builder

# Install build dependencies
RUN apk add --no-cache git make

# Install xk6 for building k6 with extensions
RUN go install go.k6.io/xk6/cmd/xk6@latest

# Build k6 with commonly used extensions
RUN xk6 build \
  --with github.com/grafana/xk6-output-influxdb@latest \
  --with github.com/grafana/xk6-dashboard@latest \
  --output /usr/bin/k6

# Stage 2: Final runtime image
FROM alpine:3.18

# Install runtime dependencies
RUN apk add --no-cache \
  ca-certificates \
  curl \
  bash \
  jq

# Copy k6 binary from builder
COPY --from=builder /usr/bin/k6 /usr/bin/k6

# Create directory for test scripts
WORKDIR /tests

# Create a non-root user for running tests
RUN addgroup -g 1000 k6 && \
  adduser -D -u 1000 -G k6 k6 && \
  chown -R k6:k6 /tests

# Switch to non-root user
USER k6

# Set environment variables
ENV K6_OUT=influxdb=http://localhost:8086/k6
ENV K6_INFLUXDB_INSECURE=true

# Default command (can be overridden)
ENTRYPOINT ["k6"]
CMD ["--help"]

# ============================================================================
# Build Instructions:
# ============================================================================
# Build the image:
#   docker build -t airbrx-k6-testing -f Dockerfile .
#
# Run a test:
#   docker run --rm \
#     -v $(pwd):/tests \
#     --network host \
#     airbrx-k6-testing run /tests/airbrx_k6_loadtesting.js
#
# Run with custom output:
#   docker run --rm \
#     -v $(pwd):/tests \
#     --network host \
#     -e K6_OUT=influxdb=http://localhost:8086/k6 \
#     airbrx-k6-testing run --out influxdb=http://localhost:8086/k6 /tests/airbrx_k6_loadtesting.js
# ============================================================================
